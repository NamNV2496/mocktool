<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock API Manager</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Mock API Manager</h1>
            <p class="subtitle">Manage your features, scenarios, and mock APIs</p>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-tab="features">Features</button>
            <button class="tab-btn" data-tab="scenarios">Scenarios</button>
            <button class="tab-btn" data-tab="mockapis">Mock APIs</button>
            <button class="tab-btn" data-tab="loadtest">Load Test Tool</button>
        </div>

        <!-- Features Tab -->
        <div id="features" class="tab-content active">
            <div class="section-header">
                <h2>Features</h2>
                <div class="filter-group">
                    <div style="display: flex; gap: 5px; flex: 1;">
                        <input type="text" id="feature-search-query" class="filter-select" placeholder="Search by feature name..." style="flex: 1;">
                        <button class="btn btn-outline" onclick="searchFeatures()" style="white-space: nowrap; padding: 8px 16px;">üîç Search</button>
                        <button class="btn btn-outline" onclick="clearFeatureSearch()" style="white-space: nowrap; padding: 8px 12px;" title="Clear search">‚úï</button>
                    </div>
                    <button class="btn btn-primary" onclick="showCreateFeatureModal()">+ New Feature</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Features Name</th>
                            <th>Description</th>
                            <th>Active</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="features-table-body">
                        <tr>
                            <td colspan="5" class="loading">Loading features...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="features-pagination" class="pagination-container"></div>
        </div>

        <!-- Scenarios Tab -->
        <div id="scenarios" class="tab-content">
            <div class="section-header">
                <h2>Scenarios</h2>
                <div class="filter-group">
                    <input type="text" id="scenario-account-id-filter" class="filter-select" placeholder="Account ID to check active status" style="width: 250px;">
                    <input type="text" id="scenario-feature-filter" class="filter-select" placeholder="Search features...">
                    <button class="btn btn-primary" onclick="showCreateScenarioModal()">+ New Scenario</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Scenarios Name</th>
                            <th>Description</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="scenarios-table-body">
                        <tr>
                            <td colspan="5" class="loading">Select a feature to view scenarios</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="scenarios-pagination" class="pagination-container"></div>
        </div>

        <!-- Mock APIs Tab -->
        <div id="mockapis" class="tab-content">
            <div class="section-header">
                <h2>Mock APIs</h2>
                <div class="filter-group">
                    <input type="text" id="mockapi-feature-filter" class="filter-select" placeholder="Search features...">
                    <input type="text" id="mockapi-scenario-filter" class="filter-select" placeholder="Search scenarios...">
                    <div style="display: flex; gap: 5px; flex: 0.8;">
                        <input type="text" id="mockapi-search-query" class="filter-select" placeholder="Search by name or path..." style="flex: 1;">
                        <button class="btn btn-outline" onclick="searchMockAPIs()" style="white-space: nowrap; padding: 8px 16px;">üîç Search</button>
                        <button class="btn btn-outline" onclick="clearMockAPISearch()" style="white-space: nowrap; padding: 8px 12px;" title="Clear search">‚úï</button>
                    </div>
                    <button class="btn btn-outline" onclick="showProtoParserModal()">Parse .proto</button>
                    <button class="btn btn-primary" onclick="showCreateMockAPIModal()">+ New Mock API</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Scenario</th>
                            <th>Mock APIs Name</th>
                            <th>Description</th>
                            <th>Method</th>
                            <th>Path</th>
                            <th>Active</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="mockapis-table-body">
                        <tr>
                            <td colspan="9" class="loading">Select a scenario to view mock APIs</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="mockapis-pagination" class="pagination-container"></div>
        </div>

        <!-- Load Test Tool Tab -->
        <div id="loadtest" class="tab-content">
            <div class="section-header">
                <h2>Load Test Scenarios</h2>
                <div class="filter-group">
                    <div style="display: flex; gap: 5px; flex: 1;">
                        <input type="text" id="loadtest-search-query" class="filter-select" placeholder="Search by scenario name..." style="flex: 1;">
                        <button class="btn btn-outline" onclick="searchLoadTestScenarios()" style="white-space: nowrap; padding: 8px 16px;">üîç Search</button>
                        <button class="btn btn-outline" onclick="clearLoadTestSearch()" style="white-space: nowrap; padding: 8px 12px;" title="Clear search">‚úï</button>
                    </div>
                    <input type="file" id="json-import-input" accept=".json" style="display: none;" onchange="handleJSONImport(event)">
                    <button class="btn btn-outline" onclick="document.getElementById('json-import-input').click()">üìÅ Import JSON</button>
                    <button class="btn btn-primary" onclick="showCreateLoadTestModal()">+ New Scenario</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>LoadTest_Name</th>
                            <th>Description</th>
                            <th>Steps</th>
                            <th>Accounts</th>
                            <th>Active</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="loadtest-table-body">
                        <tr>
                            <td colspan="7" class="loading">Loading load test scenarios...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="loadtest-pagination" class="pagination-container"></div>
        </div>
    </div>

    <!-- Modal for Creating/Editing Feature -->
    <div id="feature-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="feature-modal-title">Create Feature</h3>
                <span class="close" onclick="closeModal('feature-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="feature-id">
                <div class="form-group">
                    <label for="feature-name">Feature Name (Cannot change)</label>
                    <input type="text" id="feature-name" placeholder="Enter feature name" required>
                </div>
                <div class="form-group">
                    <label for="feature-description">Description</label>
                    <textarea id="feature-description" placeholder="Enter description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="feature-active" checked>
                        Active
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('feature-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveFeature()">Save</button>
            </div>
        </div>
    </div>

    <!-- Modal for Creating/Editing Scenario -->
    <div id="scenario-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="scenario-modal-title">Create Scenario</h3>
                <span class="close" onclick="closeModal('scenario-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="scenario-id">
                <div class="form-group">
                    <label for="scenario-feature">Feature</label>
                    <input type="text" id="scenario-feature" placeholder="Search features..." required>
                </div>
                <div class="form-group">
                    <label for="scenario-name">Scenario Name (Cannot change)</label>
                    <input type="text" id="scenario-name" placeholder="Enter scenario name" required>
                </div>
                <div class="form-group">
                    <label for="scenario-description">Description</label>
                    <textarea id="scenario-description" placeholder="Enter description" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('scenario-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveScenario()">Save</button>
            </div>
        </div>
    </div>

    <!-- Modal for Creating/Editing Mock API -->
    <div id="mockapi-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="mockapi-modal-title">Create Mock API</h3>
                <span class="close" onclick="closeModal('mockapi-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="mockapi-id">
                <div class="form-group">
                    <label for="mockapi-feature">Feature</label>
                    <input type="text" id="mockapi-feature" placeholder="Search features..." required>
                </div>
                <div class="form-group">
                    <label for="mockapi-scenario">Scenario</label>
                    <input type="text" id="mockapi-scenario" placeholder="Search scenarios..." required>
                </div>
                <div class="form-group">
                    <label for="mockapi-name">API Name</label>
                    <input type="text" id="mockapi-name" placeholder="Enter API name" required>
                </div>
                <div class="form-group">
                    <label for="mockapi-description">Description (Optional)</label>
                    <input type="text" id="mockapi-description" placeholder="Enter API description">
                </div>
                <div class="form-group">
                    <label for="mockapi-path">Path</label>
                    <input type="text" id="mockapi-path" placeholder="/api/example" required>
                </div>
                <div class="form-group">
                    <label for="mockapi-method">HTTP Method</label>
                    <select id="mockapi-method" required>
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="mockapi-regex-path">Regex Path (Optional)</label>
                    <input type="text" id="mockapi-regex-path" placeholder="/api/users/[0-9]+ example: /api/users/123456">
                </div>
                <div class="form-group">
                    <div class="json-field-header">
                        <label for="mockapi-hash-input">Request Input - JSON (Optional)</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="btn-format" onclick="formatJson('mockapi-hash-input')" title="Format JSON">‚ö° Format</button>
                            <div class="json-mode-toggle">
                                <button class="mode-btn active" data-mode="raw" onclick="switchJsonMode('mockapi-hash-input', 'raw')">Raw</button>
                                <button class="mode-btn" data-mode="tree" onclick="switchJsonMode('mockapi-hash-input', 'tree')">Tree</button>
                            </div>
                        </div>
                    </div>
                    <textarea id="mockapi-hash-input" placeholder='{"userId": 123, "action": "login"}' rows="4"></textarea>
                    <div id="mockapi-hash-input-tree" class="json-tree" style="display: none;"></div>
                    <small style="color: #718096; font-size: 0.85rem;">JSON object to generate unique hash for request matching. Keys are automatically sorted for consistent hashing.</small>
                </div>
                <div class="form-group">
                    <div class="json-field-header">
                        <label for="mockapi-output">Response Output - JSON (Required)</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="btn-format" onclick="formatJson('mockapi-output')" title="Format JSON">‚ö° Format</button>
                            <div class="json-mode-toggle">
                                <button class="mode-btn active" data-mode="raw" onclick="switchJsonMode('mockapi-output', 'raw')">Raw</button>
                                <button class="mode-btn" data-mode="tree" onclick="switchJsonMode('mockapi-output', 'tree')">Tree</button>
                            </div>
                        </div>
                    </div>
                    <textarea id="mockapi-output" placeholder='{"message": "success", "data": {...}}' rows="8" required></textarea>
                    <div id="mockapi-output-tree" class="json-tree" style="display: none;"></div>
                    <small style="color: #718096; font-size: 0.85rem;">JSON response to return when this mock API is matched</small>
                </div>
                <div class="form-group">
                    <label for="mockapi-output-header">Response Output header</label>
                    <textarea id="mockapi-output-header" placeholder='"x-corr-id":"jfd4-dsf3-3dde"' rows="8"></textarea>
                    <small style="color: #718096; font-size: 0.85rem;">Response header</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="mockapi-active" checked>
                        Active
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('mockapi-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveMockAPI()">Save</button>
            </div>
        </div>
    </div>

    <!-- Modal for Parsing .proto Files -->
    <div id="proto-parser-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Parse .proto File</h3>
                <span class="close" onclick="closeModal('proto-parser-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Upload .proto file</label>
                    <input type="file" id="proto-file-input" accept=".proto">
                </div>
                <div class="form-group">
                    <label for="proto-text-input">Or paste .proto content</label>
                    <textarea id="proto-text-input" placeholder="Paste your .proto file content here..." rows="8"></textarea>
                </div>
                <button class="btn btn-primary" onclick="parseProtoInput()">Parse</button>
                <div id="proto-results" style="display: none; margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Modal for Creating/Editing Load Test Scenario -->
    <div id="loadtest-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="loadtest-modal-title">Create Load Test Scenario</h3>
                <span class="close" onclick="closeModal('loadtest-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="loadtest-id">
                <div class="form-group">
                    <label for="loadtest-name">Scenario Name</label>
                    <input type="text" id="loadtest-name" placeholder="Enter scenario name" required>
                </div>
                <div class="form-group">
                    <label for="loadtest-description">Description</label>
                    <textarea id="loadtest-description" placeholder="Enter description" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="loadtest-accounts-input">Test Accounts (Format: username-password, comma separated)</label>
                    <textarea id="loadtest-accounts-input" placeholder="098888888-Test123456,09575757-Test123456,0966666666-Password789" rows="4" style="font-family: monospace; width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;"></textarea>
                    <small style="color: #718096; font-size: 0.85rem; display: block; margin-top: 5px;">
                        Enter username-password pairs separated by commas. These accounts will be used as {{username}} and {{password}} variables in test steps.
                    </small>
                    <div style="margin-top: 8px;">
                        <strong style="font-size: 13px;">Accounts count: <span id="loadtest-accounts-count">0</span></strong>
                    </div>
                </div>
                <div class="form-group">
                    <label>Steps</label>
                    <div id="loadtest-steps-container">
                        <!-- Other steps will be added here dynamically -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addLoadTestStep()" style="margin-top: 10px;">+ Add Step</button>
                </div>
                <!-- <div class="form-group" style="display: none;">
                    <label>Accounts (<span id="loadtest-accounts-count-old">0</span>)</label>
                    <button type="button" class="btn btn-secondary" onclick="showAccountsModalFromLoadTest()" style="margin-top: 5px;">Manage Accounts</button>
                    <small style="color: #718096; font-size: 0.85rem; display: block; margin-top: 5px;">Add test accounts (username-password pairs) to use in load testing</small>
                </div> -->
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="loadtest-active" checked>
                        Active
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('loadtest-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveLoadTestScenario()">Save</button>
            </div>
        </div>
    </div>


    <!-- Variable Extraction Row Template (hidden) -->
    <template id="variable-row-template">
        <div class="variable-row" style="display: grid; grid-template-columns: 1fr 2fr 30px; gap: 5px; margin-bottom: 5px; align-items: center;">
            <input type="text" class="var-name" placeholder="Variable name (e.g., token)" style="padding: 5px; font-size: 12px;">
            <input type="text" class="var-jsonpath" placeholder="data.token or header.X-Header-Name" style="padding: 5px; font-size: 12px;">
            <button type="button" class="btn btn-delete" onclick="this.closest('.variable-row').remove()" style="padding: 3px 6px; font-size: 10px;">X</button>
        </div>
    </template>

    <!-- Step Template (hidden) -->
    <template id="loadtest-step-template">
        <div class="loadtest-step" style="border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 10px; border-radius: 8px; background: #f8fafc;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong>Step <span class="step-number"></span></strong>
                <button type="button" class="btn btn-delete" onclick="removeLoadTestStep(this)" style="padding: 5px 10px;">Remove</button>
            </div>
            <div class="form-group">
                <label>Step Name</label>
                <input type="text" class="step-name" placeholder="e.g., login, get_profile" required>
            </div>
            <div class="form-group" style="background: #fff3cd; padding: 12px; border-radius: 6px; border: 1px solid #ffc107;">
                <label style="font-weight: bold; color: #856404; display: flex; align-items: center; gap: 5px;">
                    <span>‚ö°</span> Execution Condition (optional)
                </label>
                <input type="text" class="step-condition" placeholder='({{need_payment}} == true && {{status}} == "active") || {{count}} >= 0' style="width: 100%; margin-top: 5px;">
                <small style="color: #856404; font-size: 0.8rem; display: block; margin-top: 5px;">
                    <strong>Execute this step only if condition is met.</strong><br>
                    ‚Ä¢ Simple: <code>{{need_payment}} == true</code><br>
                    ‚Ä¢ AND: <code>{{var1}} == true && {{var2}} > 0</code><br>
                    ‚Ä¢ OR: <code>{{var1}} == true || {{var2}} == false</code><br>
                    ‚Ä¢ Complex: <code>({{need_payment}} == true && {{status}} == "active") || {{count}} >= 0</code><br>
                    ‚Ä¢ Operators: ==, !=, >, <, >=, <=, &&, ||, ( )
                </small>
            </div>
            <div class="form-group">
                <label>Path or cURL Command</label>
                <textarea class="step-path" placeholder="https://api.example.com/login

OR paste cURL from Postman:
curl --location 'https://api.example.com/login' \
--header 'Content-Type: application/json' \
--data '{\"username\": \"{{username}}\"}'" rows="4" style="font-family: monospace; font-size: 12px;" required></textarea>
                <small style="color: #3b82f6; font-size: 0.8rem;">
                    <strong>Tip:</strong> Paste cURL from Postman to auto-extract URL, method, headers, and body. Use {{username}}, {{password}}, or any saved variable.
                </small>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group">
                    <label>Method (override cURL)</label>
                    <select class="step-method">
                        <option value="" selected>Auto (from cURL or GET)</option>
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Expected Status Code</label>
                    <input type="number" class="step-expectstatus" placeholder="200" value="200">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <div class="form-group">
                    <label>Retry for Seconds (0 = no retry)</label>
                    <input type="number" class="step-retry-for-seconds" placeholder="0" value="0" min="0">
                    <small style="color: #718096; font-size: 0.8rem;">Retry failed requests for this many seconds (1s interval)</small>
                </div>
                <div class="form-group">
                    <label>Max Retry Times (0 = unlimited)</label>
                    <input type="number" class="step-max-retry-times" placeholder="1" value="1" min="0">
                    <small style="color: #718096; font-size: 0.8rem;">Maximum retry attempts (stops when reached or time expires)</small>
                </div>
                <div class="form-group">
                    <label>Wait After Seconds (0 = no wait)</label>
                    <input type="number" class="step-wait-after-seconds" placeholder="0" value="0" min="0">
                    <small style="color: #718096; font-size: 0.8rem;">Wait after successful execution before next step</small>
                </div>
            </div>
            <div class="form-group">
                <label>Headers (override cURL headers)</label>
                <textarea class="step-headers" placeholder='{"Authorization": "Bearer {{access_token}}"}' rows="2"></textarea>
                <small style="color: #718096; font-size: 0.8rem;">Optional. Add or override headers from cURL.</small>
            </div>
            <div class="form-group">
                <label>Request Body (override cURL body)</label>
                <textarea class="step-body" placeholder='{"username": "{{username}}", "password": "{{password}}"}' rows="3"></textarea>
                <small style="color: #718096; font-size: 0.8rem;">Optional. Override body from cURL if needed.</small>
            </div>
            <div class="form-group">
                <label>Extract Variables from Response and SAVE FOR FUTURE</label>
                <div class="step-variables-container">
                    <!-- Variables will be added dynamically -->
                </div>
                <button type="button" class="btn btn-secondary" onclick="addStepVariable(this)" style="margin-top: 5px; padding: 3px 8px; font-size: 12px;">+ Add Variable</button>
                <small style="color: #718096; font-size: 0.8rem; display: block; margin-top: 5px;">
                    Extract values from response to use in next steps with {{variable_name}}<br>
                    <strong>From body:</strong> data.token, ads.0.account_id (dot notation for arrays)<br>
                    <strong>From header:</strong> header.X-Correlation-Id, header.Authorization
                </small>
            </div>
        </div>
    </template>

    <script src="app.js"></script>
</body>
</html>
